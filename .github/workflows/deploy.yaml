name: Build and Deploy to Kubernetes (VPS)

on:
  push:
    branches: [ main ]
    tags: [ 'v*.*.*' ]
  workflow_dispatch:
    inputs:
      dry_run:
        description: "Build only (no push, no deploy)"
        required: false
        default: "true"
        type: choice
        options: [ "true", "false" ]

env:
  SERVICE_NAME: kcca-kla-connect-api-web
  # Evaluate DRY_RUN for both push and manual dispatch
  DRY_RUN: ${{ github.event_name == 'workflow_dispatch' && inputs.dry_run == 'true' }}

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    permissions:
      contents: read

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Log in to Docker registry (if custom registry)
        if: env.REGISTRY != '' && env.REGISTRY != 'ghcr.io'
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ secrets.REGISTRY_USERNAME }}
          password: ${{ secrets.REGISTRY_PASSWORD }}

      - name: Derive image tags
        id: vars
        run: |
          SHA_TAG=${GITHUB_SHA::12}
          echo "sha_tag=${SHA_TAG}" >> $GITHUB_OUTPUT
          echo "ref_name=${GITHUB_REF_NAME}" >> $GITHUB_OUTPUT

      - name: Build image (push depends on DRY_RUN)
        uses: docker/build-push-action@v6
        with:
          context: .
          platforms: linux/amd64  # Build for Linux AMD64 (VPS compatibility)
          push: ${{ env.DRY_RUN != 'true' }}
          tags: |
            ${{ env.REGISTRY }}/${{ env.IMAGE_OWNER }}/${{ env.IMAGE_NAME }}:${{ steps.vars.outputs.sha_tag }}
            ${{ env.REGISTRY }}/${{ env.IMAGE_OWNER }}/${{ env.IMAGE_NAME }}:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Set up kubectl
        if: env.DRY_RUN != 'true'
        run: |
          mkdir -p $HOME/.kube
          echo "${KUBECONFIG_DATA}" | base64 -d > $HOME/.kube/config
        env:
          KUBECONFIG_DATA: ${{ secrets.KUBECONFIG_DATA }}

      - name: Deploy to cluster (non-interactive)
        if: env.DRY_RUN != 'true'
        env:
          NO_CONFIRM: "true"
          SKIP_BUILD: "true"
          REGISTRY: ${{ env.REGISTRY }}
          IMAGE_TAG: ${{ steps.vars.outputs.sha_tag }}
          SKIP_DB: ${{ env.SKIP_DB || 'true' }}
        run: |
          make deploy-vps

    env:
      # Default to GHCR
      REGISTRY: ${{ vars.CONTAINER_REGISTRY || 'ghcr.io' }}
      IMAGE_OWNER: ${{ vars.IMAGE_OWNER || 'mutesasiratimo' }}
      IMAGE_NAME: kcca_kla_connect_api
      # Optional: whether to skip DB deployment (default true)
      SKIP_DB: ${{ vars.SKIP_DB }}


